<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>En mere tak! - husk at drikke ansvarligt</title>
    <link rel="stylesheet" href="./static/bulma.min.css">
    <link rel="stylesheet" href="./static/leaflet.css">
    <script src="./static/leaflet.js"></script>
</head>
<style>
    .box {
        z-index: 9999;
        position: relative;
    }
</style>
<body>
    <section id="map" class="hero section is-fullheight">
        <div class="columns">
            <div class="column">
            </div>
            <div class="column">
            </div>
            <div class="column">
            </div>
            <div class="column">
            </div>
            <div class="column">
                <div style="background: transparent;" id="bar-container" class="box">
                </div>
            </div>
        </div>
    </section>
    <script>
        var myStyle = {
            "color": "#00b0ff",
            "weight": 5,
            "opacity": 1,
            "lineCap": "round",
            "lineJoin": "round"
        };

        var style = {
            color: "#00b0ff",
            weight: 5,
            opacity: 1
            }, 
        stroke = {
            color: "#1967d2 ",
            weight: 8,
            opacity: 1
            };


        
        var barcontainer = document.querySelector('#bar-container');
                
        var map = L.map('map').setView([55.676098, 12.568337], 13);
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var layerGroup = L.layerGroup().addTo(map);

        map.locate({setView: true, maxZoom: 16});
        function onLocationFound(e) {
            var radius = e.accuracy;

            L.marker(e.latlng).addTo(layerGroup)/*
                .bindPopup("You are within " + radius + " meters from this point").openPopup()*/;
            getNearestBar(e.latlng)
            /*L.circle(e.latlng, radius).addTo(map)*/;
        }
        map.on('locationfound', onLocationFound);

        map.on('click', function(e) {
            layerGroup.clearLayers();
            L.marker(e.latlng).addTo(layerGroup);
            getNearestBar(e.latlng);

        });



        function getNearestBar(latlng) {    
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET","http://159.89.28.191:8000/route/" + String(latlng.lng) + "/" + String(latlng.lat), true)
            xhttp.onreadystatechange    = function () {
            if (this.readyState == 4 && this.status == 200) {
                barcontainer.innerHTML = "";
                var data = JSON.parse(this.responseText);
                const route = data.route[0];
                const parsedRoute = JSON.parse(route);
                L.geoJSON(parsedRoute, {style: stroke}).addTo(layerGroup);
                L.geoJSON(parsedRoute, {style: style}).addTo(layerGroup);
                const routeCoords = JSON.parse(data.route[0]);
                const barName = data.barname;
                const coords = routeCoords.coordinates;
                const altName = data.altname;
                L.marker({"lng": coords[coords.length - 1][0], "lat": coords[coords.length -1][1]}).addTo(layerGroup);
                barcontainer = document.querySelector('#bar-container')
                var card = `<div class="card">
                    <div class="card-image">
                    <figure class="image is-4by3">
                    <img src="https://bulma.io/images/placeholders/1280x960.png" alt="Placeholder image">
                    </figure>
                    </div>
                    <div class="card-content">
                    <div class="media">
                    <div class="media-content">
                    <p class="title is-4">`+ barName+ `</p>
                    <p class="subtitle is-6">Den er ordentlig syg</p>
                    </div>
                    </div>
                    <div class="content">
                    Hvad er der at sige om denne bar?
                    <a href="#">#css</a> <a href="#">#responsive</a>
                    <br>
                    <time datetime="2016-1-1">11:09 PM - 1 Jan 2016</time>
                    </div>
                    </div>
                    </div>`
                barcontainer.innerHTML = card
                }
            }
            // Sending our request
            xhttp.send();
        };
    </script>
</body>
</html>
