<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>En mere tak! - husk at drikke ansvarligt</title>
    <link rel="stylesheet" href="./static/bulma.min.css">
    <link rel="stylesheet" href="./static/leaflet.css">
    <script src="./static/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="./static/leaflet.extra-markers.min.css">
    <script src="./static/leaflet.extra-markers.js"></script>
</head>
<style>
    .box {
        z-index: 9999;
        position: relative;
    }
</style>
<body>
    <section id="map" class="hero section is-fullheight">
        <div class="columns">
            <div class="column">
            </div>
            <div class="column">
            </div>
            <div class="column">
            </div>
            <div class="column">
            </div>
            <div class="column">
                <div style="background: transparent;" id="bar-container" class="box">
                </div>
            </div>
        </div>
    </section>
    <script>
        var myStyle = {
            "color": "#00b0ff",
            "weight": 5,
            "opacity": 1,
            "lineCap": "round",
            "lineJoin": "round"
        };

        var style = {
            color: "#00b0ff",
            weight: 5,
            opacity: 1
            }, 
        stroke = {
            color: "#1967d2 ",
            weight: 8,
            opacity: 1
            };

        var youAreHere = L.ExtraMarkers.icon({
            icon: 'bi-arrow-down',
            markerColor: 'cyan',
            shape: 'round',
            prefix: 'bi'
        });

        var drinkTime = L.ExtraMarkers.icon({
            icon: 'bi-bell',
            markerColor: 'green-light',
            shape: 'star',
            prefix: 'bi'
        });
        /*
        var cocktail = L.ExtraMarkers.icon({
            icon: 'bi-cup-straw',
            markerColor: 'red',
            shape: 'square',
            prefix: 'bi'
        });
        var pub = L.ExtraMarkers.icon({
            icon: 'bi-cup-straw',
            markerColor: 'red',
            shape: 'square',
            prefix: 'bi'
        });
        
        var nightclub = L.ExtraMarkers.icon({
            icon: 'bi-cup-straw',
            markerColor: 'red',
            shape: 'square',
            prefix: 'bi'
        });
        */
        
        
        var barcontainer = document.querySelector('#bar-container');
                
        var map = L.map('map').setView([55.676098, 12.568337], 13);
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var layerGroup = L.layerGroup().addTo(map);

        map.locate({setView: true, maxZoom: 16});
        function onLocationFound(e) {
            var radius = e.accuracy;

            L.marker(e.latlng, {icon: youAreHere}).addTo(layerGroup)/*
                .bindPopup("You are within " + radius + " meters from this point").openPopup()*/;
            getNearestBar(e.latlng)
            /*L.circle(e.latlng, radius).addTo(map)*/;
        }
        map.on('locationfound', onLocationFound);

        map.on('click', function(e) {
            layerGroup.clearLayers();
            L.marker(e.latlng).addTo(layerGroup);
            getNearestBar(e.latlng);

        });



        function getNearestBar(latlng) {    
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET","http://159.89.28.191:8000/route/" + String(latlng.lng) + "/" + String(latlng.lat), true)
            xhttp.onreadystatechange    = function () {
            if (this.readyState == 4 && this.status == 200) {
                barcontainer.innerHTML = "";
                var data = JSON.parse(this.responseText);
                /* Handle the quickest route */
                const route = data.route[0];
                const parsedRoute = JSON.parse(route);
                L.geoJSON(parsedRoute, {style: stroke}).addTo(layerGroup);
                L.geoJSON(parsedRoute, {style: style}).addTo(layerGroup);
                const routeCoords = JSON.parse(data.route[0]);
                const coords = routeCoords.coordinates;
                L.marker({"lng": coords[coords.length - 1][0], "lat": coords[coords.length -1][1]},{icon: drinkTime}).addTo(layerGroup);
                
                /* Handle other data*/
                const barName = data.metadataBar[0][0][0].name;
                const altName = data.metadataBar[0][0][0].altname;
                
                barcontainer = document.querySelector('#bar-container')
                var card = `<div class="card">
                    <div class="card-image">
                    <figure class="image is-4by3">
                    <img src="https://bulma.io/images/placeholders/1280x960.png" alt="Placeholder image">
                    </figure>
                    </div>
                    <div class="card-content">
                    <p class="title is-5">`+ barName+ `</p>
                    <p class="subtitle is-6">` + altName + `</p>
                    <div class="content">
                    <p>
                    En kort beskrivelse kommer her ?
                    </p>
                    <p>
                    -- Den lukker kl. 02:00, det er om!
                    </p>

                    <!-- SOCIAL MEDIA -->
                    <a href="#">instagram</a> <a href="#">facebook</a>
                    <br>
                    </div>
                    </div>
                    </div>`
                barcontainer.innerHTML = card
                }
            }
            // Sending our request
            xhttp.send();
        };
    </script>
</body>
</html>
